name: Deploy to EC2

on:
  push:
    branches: [ main ]        # main ì— push ë  ë•Œë§ˆë‹¤ ë°°í¬

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4     # ì½”ë“œë°›ê¸°

      - uses: webfactory/ssh-agent@v0.9.0    # Secret í‚¤ ë¡œë“œ
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known_hosts        # í˜¸ìŠ¤íŠ¸í‚¤ ê²½ê³  ì œê±°
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on EC2
        env:
          HOST:  ${{ secrets.EC2_HOST }}
          USER:  ${{ secrets.EC2_USER }}
        run: |
          ssh $USER@$HOST <<'EOF'
            set -e
            cd /home/ec2-user/9oormthonUNIV-BE   # ðŸ‘ˆ í”„ë¡œì íŠ¸ í´ë” ê²½ë¡œ

            git fetch --all
            git reset --hard origin/main        # ìµœì‹  ì½”ë“œë¡œ ë§žì¶”ê¸°

            docker compose build --no-cache   # EC2ì—ì„œ ë¹Œë“œí•  ë• ì‚¬ìš©
            # docker compose pull                    # ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì“°ë©´ ì´ ì¤„ë§Œ

            docker compose down
            docker compose up -d --remove-orphans
          EOF
